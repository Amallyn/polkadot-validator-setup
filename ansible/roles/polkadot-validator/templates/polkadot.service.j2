{# --- PREPARE VARIABLES #}
{% set nodeName = hostvars[inventory_hostname].nodeName|default(None) %}
{% set execution = hostvars[inventory_hostname].execution|default(None) %}
{% set wasmExecution = hostvars[inventory_hostname].wasmExecution|default(None) %}
{% set telemetryUrl = hostvars[inventory_hostname].telemetryUrl|default(None) %}
{% set enableReverseProxy = hostvars[inventory_hostname].enableReverseProxy|default(None) %}
{% set loggingFilter = hostvars[inventory_hostname].loggingFilter|default(None) %}
{% set basePath = hostvars[inventory_hostname].basePath|default(None) %}
{% set additionalFlags = hostvars[inventory_hostname].additionalFlags|default(None) %}
{# ## Legacy/deprecated flags #}
{% if wasmExecution is undefined %}
  {% set wasmExecution = hostvars[inventory_hostname].wasm_execution|default(None) %}
{% endif %}
{% if basePath is undefined %}
  {% set basePath = hostvars[inventory_hostname].base_path|default(None) %}
{% endif %}
{% set additionalCommonFlags = hostvars[inventory_hostname].polkadot_additional_common_flags|default(None) %}
{% set additionalValidatorFlags = hostvars[inventory_hostname].polkadot_additional_validator_flags|default(None) %}
{# --- #}
[Unit]
Description=Polkadot Node

[Service]
User=polkadot
Group=polkadot
ExecStart=/usr/local/bin/polkadot \
  --validator \
  --chain={{ chain }} \
  --listen-addr=/ip4/127.0.0.1/tcp/{{ p2p_port }} \
  --rpc-methods=Unsafe \
  --execution {{ execution }} \
  {% if nodeName is defined and nodeName|length %}
  {{ nodeName }} \
  {% else %}
  {{ project|default('project') }}-sv-validator-{{ groups['validator'].index(inventory_hostname) }} \
  {% endif %}
  {% if wasmExecution is defined and wasmExecution|length %}
  --wasm-execution {{ wasmExecution }} \
  {% else %}
  --wasm-execution Compiled \
  {% endif %}
  {% if telemetryUrl is defined and telemetryUrl|length %}
  --telemetry-url '{{ telemetryUrl }} 1' \
  {% else %}
  --no-telemetry \
  {% endif %}
  {% if enableReverseProxy is defined and enableReverseProxy %}
  --public-addr=/ip4/{{ hostvars[inventory_hostname].public_ip.json.ip }}/tcp/{{ proxy_port }} \
  {% endif %}
  {% if loggingFilter is defined and loggingFilter|length %}
  -l{{ loggingFilter }} \
  {% endif %}
  {% if basePath is defined and basePath|length %}
  --base-path '{{ basePath }}' \
  {% endif %}
  {% if additionalFlags is defined and additionalFlags|length %}
  {{ additionalFlags }} \
  {% endif %}
  {# --- DEPRECATED --- #}
  {% if additionalCommonFlags is defined and additionalCommonFlags|length %}
  {{ additionalCommonFlags }} \
  {% endif %}
  {% if additionalValidatorFlags is defined and additionalValidatorFlags|length %}
  {{ additionalValidatorFlags }} \
  {% endif %}
  {# --- #}

Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
